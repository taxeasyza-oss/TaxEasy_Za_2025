<!-- index-enhanced.html - COMPLETE REDESIGNED 5-PAGE WIZARD -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxEasy_ZA - Professional SA Tax Calculator 2025 | SARS Compliant</title>
    <meta name="description" content="Calculate your 2025 South African personal income tax accurately. Free SARS-compliant calculator with detailed breakdowns, deductions, and professional PDF reports.">
    
    <!-- Enhanced styling -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/professional-layout.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PayFast integration -->
    <script src="https://www.payfast.co.za/eng/process/recurring/form.js"></script>
    
    <!-- PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Core application files -->
    <script src="/js/tax-calculator.js" type="module" defer></script>
    <script src="/js/wizard-navigation.js" type="module" defer></script>
    <script src="/js/payfast.js" defer></script>
    <script src="/js/pdf-generator.js" type="module" defer></script>
    <script src="/js/app.js" type="module" defer></script>
</head>
<body>
    <!-- Header with branding -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <h1 class="logo">TaxEasy_ZA</h1>
                <span class="tagline">Professional Tax Calculator 2025</span>
            </div>
            <div class="header-controls">
                <select id="langSelect" class="language-selector">
                    <option value="en">English</option>
                    <option value="af">Afrikaans</option>
                    <option value="zu">isiZulu</option>
                    <option value="xh">isiXhosa</option>
                    <option value="st">Sesotho</option>
                </select>
            </div>
        </div>
        
        <!-- Progress indicator -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
            <div class="step-indicator" id="step-indicator">Step 1 of 5</div>
        </div>
    </header>

    <!-- Main application container -->
    <div class="calculator-container">
        <!-- Left side: Main wizard form -->
        <div class="main-form">
            <!-- Navigation buttons -->
            <div class="wizard-navigation">
                <button type="button" id="prevBtn" class="nav-btn nav-prev" onclick="wizard.previousPage()">
                    ← Previous
                </button>
                <div class="page-dots">
                    <span class="dot active" data-page="1"></span>
                    <span class="dot" data-page="2"></span>
                    <span class="dot" data-page="3"></span>
                    <span class="dot" data-page="4"></span>
                    <span class="dot" data-page="5"></span>
                </div>
                <button type="button" id="nextBtn" class="nav-btn nav-next" onclick="wizard.nextPage()">
                    Next →
                </button>
            </div>

            <!-- PAGE 1: Personal Information -->
            <div class="wizard-page active" id="page-1">
                <div class="page-header">
                    <h2 data-translate="personal_info_title">Personal Information</h2>
                    <p data-translate="personal_info_desc">Enter your basic details for accurate tax calculation</p>
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label for="fullName" data-translate="full_name">Full Name</label>
                        <input type="text" id="fullName" name="fullName" required 
                               placeholder="Enter your full name as per SARS records">
                        <div class="field-help">Used for PDF report generation</div>
                    </div>

                    <div class="input-group">
                        <label for="idNumber" data-translate="id_number">ID / Passport Number</label>
                        <input type="text" id="idNumber" name="idNumber" required 
                               placeholder="1234567890123 or AB123456">
                        <div class="field-help">South African ID (13 digits) or Passport number</div>
                    </div>

                    <div class="input-group">
                        <label for="age" data-translate="age_group">Age Group</label>
                        <select id="age" name="age" required>
                            <option value="">Select age group</option>
                            <option value="under65">Under 65 years</option>
                            <option value="65-74">65-74 years</option>
                            <option value="75+">75+ years</option>
                        </select>
                        <div class="tooltip-icon" data-tooltip="age_tooltip">?</div>
                        <div class="field-help">Different tax thresholds apply based on age</div>
                    </div>

                    <div class="input-group">
                        <label for="taxYear" data-translate="tax_year">Tax Year</label>
                        <select id="taxYear" name="taxYear" readonly>
                            <option value="2025" selected>2025 (1 Mar 2024 - 28 Feb 2025)</option>
                        </select>
                        <div class="field-help">Current tax year period</div>
                    </div>

                    <div class="input-group">
                        <label for="email" data-translate="email_address">Email Address</label>
                        <input type="email" id="email" name="email" 
                               placeholder="your.email@example.com">
                        <div class="field-help">Optional: For PDF report delivery and updates</div>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: Income Sources -->
            <div class="wizard-page" id="page-2">
                <div class="page-header">
                    <h2 data-translate="income_title">Income & IRP5 Information</h2>
                    <p data-translate="income_desc">Enter all your income sources from IRP5 certificates and other sources</p>
                </div>

                <div class="income-sections">
                    <!-- Employment Income -->
                    <div class="form-section">
                        <h3>Employment Income</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="basicSalary">Basic Salary (Code 3601)</label>
                                <input type="number" id="basicSalary" name="basicSalary" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="tooltip-icon" data-tooltip="basic_salary_tooltip">?</div>
                            </div>

                            <div class="input-group">
                                <label for="bonus">Bonuses & 13th Cheque (Code 3605)</label>
                                <input type="number" id="bonus" name="bonus" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="tooltip-icon" data-tooltip="bonus_tooltip">?</div>
                            </div>

                            <div class="input-group">
                                <label for="commission">Commission (Code 3606)</label>
                                <input type="number" id="commission" name="commission" 
                                       placeholder="0.00" step="0.01" min="0">
                            </div>

                            <div class="input-group">
                                <label for="overtime">Overtime (Code 3604)</label>
                                <input type="number" id="overtime" name="overtime" 
                                       placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Allowances -->
                    <div class="form-section">
                        <h3>Allowances</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="travelAllowance">Travel Allowance (Code 3701)</label>
                                <input type="number" id="travelAllowance" name="travelAllowance" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="tooltip-icon" data-tooltip="travel_allowance_tooltip">?</div>
                            </div>

                            <div class="input-group">
                                <label for="cellphoneAllowance">Cellphone Allowance (Code 3702)</label>
                                <input type="number" id="cellphoneAllowance" name="cellphoneAllowance" 
                                       placeholder="0.00" step="0.01" min="0">
                            </div>

                            <div class="input-group">
                                <label for="otherAllowances">Other Allowances</label>
                                <input type="number" id="otherAllowances" name="otherAllowances" 
                                       placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Investment Income -->
                    <div class="form-section">
                        <h3>Investment & Other Income</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="interestIncome">Interest Income</label>
                                <input type="number" id="interestIncome" name="interestIncome" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="field-help">From banks, investments (R23,800 exempt for under 65)</div>
                            </div>

                            <div class="input-group">
                                <label for="dividendIncome">Dividend Income</label>
                                <input type="number" id="dividendIncome" name="dividendIncome" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="field-help">From JSE listed shares and investments</div>
                            </div>

                            <div class="input-group">
                                <label for="rentalIncome">Rental Income</label>
                                <input type="number" id="rentalIncome" name="rentalIncome" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="field-help">Gross rental income (before expenses)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: General Deductions -->
            <div class="wizard-page" id="page-3">
                <div class="page-header">
                    <h2 data-translate="deductions_title">General Deductions</h2>
                    <p data-translate="deductions_desc">Standard deductions available to all taxpayers</p>
                </div>

                <div class="deduction-sections">
                    <!-- Retirement Funding -->
                    <div class="form-section">
                        <h3>Retirement Funding (Max 27.5% of income or R350,000)</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="pensionFund">Pension Fund Contributions</label>
                                <input type="number" id="pensionFund" name="pensionFund" 
                                       placeholder="0.00" step="0.01" min="0" max="350000">
                                <div class="tooltip-icon" data-tooltip="pension_tooltip">?</div>
                            </div>

                            <div class="input-group">
                                <label for="providentFund">Provident Fund Contributions</label>
                                <input type="number" id="providentFund" name="providentFund" 
                                       placeholder="0.00" step="0.01" min="0" max="350000">
                            </div>

                            <div class="input-group">
                                <label for="retirementAnnuity">Retirement Annuity Contributions</label>
                                <input type="number" id="retirementAnnuity" name="retirementAnnuity" 
                                       placeholder="0.00" step="0.01" min="0" max="350000">
                                <div class="tooltip-icon" data-tooltip="ra_tooltip">?</div>
                            </div>
                        </div>
                        <div class="retirement-summary">
                            <div class="summary-item">
                                <span>Total Retirement Contributions:</span>
                                <span id="totalRetirement">R0</span>
                            </div>
                            <div class="summary-item">
                                <span>Remaining Allowance:</span>
                                <span id="remainingRetirement">R0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Medical Aid -->
                    <div class="form-section">
                        <h3>Medical Aid</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="medicalAid">Annual Medical Aid Contributions</label>
                                <input type="number" id="medicalAid" name="medicalAid" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="tooltip-icon" data-tooltip="medical_aid_tooltip">?</div>
                            </div>

                            <div class="input-group">
                                <label for="medicalMembers">Number of Members</label>
                                <input type="number" id="medicalMembers" name="medicalMembers" 
                                       placeholder="0" min="0" max="10">
                            </div>

                            <div class="input-group">
                                <label for="medicalDependants">Number of Dependants</label>
                                <input type="number" id="medicalDependants" name="medicalDependants" 
                                       placeholder="0" min="0" max="20">
                            </div>

                            <div class="input-group">
                                <label for="additionalMedical">Additional Medical Expenses</label>
                                <input type="number" id="additionalMedical" name="additionalMedical" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="field-help">Out-of-pocket medical expenses not covered by medical aid</div>
                            </div>
                        </div>
                        <div class="medical-summary">
                            <div class="summary-item">
                                <span>Medical Aid Tax Credits:</span>
                                <span id="medicalCredits">R0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Other Deductions -->
                    <div class="form-section">
                        <h3>Other General Deductions</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="donations">Donations (Section 18A)</label>
                                <input type="number" id="donations" name="donations" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="field-help">Max 10% of taxable income to approved organizations</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 4: Advanced Deductions -->
            <div class="wizard-page" id="page-4">
                <div class="page-header">
                    <h2 data-translate="advanced_title">Advanced Deductions</h2>
                    <p data-translate="advanced_desc">Occupation-specific and specialized deductions</p>
                </div>

                <div class="advanced-sections">
                    <!-- Occupation Specific -->
                    <div class="form-section">
                        <h3>Occupation-Specific Deductions</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="occupation">Primary Occupation</label>
                                <select id="occupation" name="occupation">
                                    <option value="">-- Select Occupation --</option>
                                    <option value="IT Professional">IT Professional</option>
                                    <option value="Healthcare Worker">Healthcare Worker</option>
                                    <option value="Educator">Educator/Teacher</option>
                                    <option value="Engineer">Engineer</option>
                                    <option value="Finance Professional">Finance Professional</option>
                                    <option value="Legal Professional">Legal Professional</option>
                                    <option value="Sales & Marketing">Sales & Marketing</option>
                                    <option value="Trades & Technical">Trades & Technical</option>
                                    <option value="Transport & Logistics">Transport & Logistics</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="tooltip-icon" data-tooltip="occupation_tooltip">?</div>
                            </div>
                        </div>

                        <!-- Dynamic occupation-specific fields will be populated here -->
                        <div id="occupationSpecificFields" class="occupation-fields"></div>
                    </div>

                    <!-- Travel Expenses -->
                    <div class="form-section">
                        <h3>Business Travel Expenses</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="businessKm">Business Kilometers</label>
                                <input type="number" id="businessKm" name="businessKm" 
                                       placeholder="0" min="0" max="100000">
                                <div class="field-help">Annual business-related kilometers</div>
                            </div>

                            <div class="input-group">
                                <label for="fuelExpenses">Fuel Expenses</label>
                                <input type="number" id="fuelExpenses" name="fuelExpenses" 
                                       placeholder="0.00" step="0.01" min="0">
                            </div>

                            <div class="input-group">
                                <label for="vehicleMaintenance">Vehicle Maintenance</label>
                                <input type="number" id="vehicleMaintenance" name="vehicleMaintenance" 
                                       placeholder="0.00" step="0.01" min="0">
                            </div>

                            <div class="input-group">
                                <label for="tollsParking">Tolls & Parking</label>
                                <input type="number" id="tollsParking" name="tollsParking" 
                                       placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Renewable Energy -->
                    <div class="form-section">
                        <h3>Renewable Energy (Section 12B)</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="solarPV">Solar PV System</label>
                                <input type="number" id="solarPV" name="solarPV" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="tooltip-icon" data-tooltip="solar_pv_tooltip">?</div>
                                <div class="field-help">Solar panel installation costs</div>
                            </div>

                            <div class="input-group">
                                <label for="solarWaterHeater">Solar Water Heater</label>
                                <input type="number" id="solarWaterHeater" name="solarWaterHeater" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="field-help">Solar geyser installation costs</div>
                            </div>

                            <div class="input-group">
                                <label for="otherRenewable">Other Renewable Energy</label>
                                <input type="number" id="otherRenewable" name="otherRenewable" 
                                       placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Home Office -->
                    <div class="form-section">
                        <h3>Home Office Expenses</h3>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="homeOffice">Home Office Expenses</label>
                                <input type="number" id="homeOffice" name="homeOffice" 
                                       placeholder="0.00" step="0.01" min="0">
                                <div class="tooltip-icon" data-tooltip="home_office_tooltip">?</div>
                                <div class="field-help">Portion of home expenses used for work</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE 5: Tax Summary & Payment -->
            <div class="wizard-page" id="page-5">
                <div class="page-header">
                    <h2 data-translate="summary_title">Tax Calculation Summary</h2>
                    <p data-translate="summary_desc">Review your tax calculation and generate professional report</p>
                </div>

                <div class="summary-sections">
                    <!-- Tax Calculation Results -->
                    <div class="calculation-results">
                        <div class="result-card primary">
                            <div class="result-header">
                                <h3>Final Tax Calculation</h3>
                                <div class="tax-year-badge">2025 Tax Year</div>
                            </div>
                            <div class="result-grid">
                                <div class="result-item">
                                    <span class="label">Gross Annual Income:</span>
                                    <span class="value" id="summaryGrossIncome">R0</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Total Deductions:</span>
                                    <span class="value" id="summaryDeductions">R0</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Taxable Income:</span>
                                    <span class="value" id="summaryTaxableIncome">R0</span>
                                </div>
                                <div class="result-item highlight">
                                    <span class="label">Annual Tax Payable:</span>
                                    <span class="value" id="summaryTaxPayable">R0</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Monthly Tax:</span>
                                    <span class="value" id="summaryMonthlyTax">R0</span>
                                </div>
                                <div class="result-item">
                                    <span class="label">Effective Tax Rate:</span>
                                    <span class="value" id="summaryEffectiveRate">0.0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tax Bracket Breakdown -->
                        <div class="result-card">
                            <h3>Tax Bracket Breakdown</h3>
                            <div id="bracketBreakdown" class="bracket-breakdown">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Report Options -->
                    <div class="report-options">
                        <div class="option-card">
                            <h3>📄 Basic Report (Free)</h3>
                            <ul>
                                <li>Tax calculation summary</li>
                                <li>Basic breakdown</li>
                                <li>Watermarked PDF</li>
                            </ul>
                            <button class="btn btn-secondary" onclick="generateBasicReport()">
                                Download Basic Report
                            </button>
                        </div>

                        <div class="option-card featured">
                            <h3>💼 Professional Report (R99)</h3>
                            <div class="price-badge">R99</div>
                            <ul>
                                <li>Detailed tax calculation with all brackets</li>
                                <li>Occupation-specific deduction analysis</li>
                                <li>Tax optimization recommendations</li>
                                <li>SARS submission guidelines</li>
                                <li>Professional branded PDF</li>
                                <li>Email delivery & cloud storage</li>
                            </ul>
                            <button class="btn btn-primary" onclick="purchaseProfessionalReport()">
                                Purchase Professional Report
                            </button>
                            <div class="payment-methods">
                                <img src="/images/payfast-logo.png" alt="PayFast" class="payment-logo">
                                <span>Secure payment via PayFast</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-outline" onclick="wizard.restartCalculator()">
                            Start Over
                        </button>
                        <button class="btn btn-secondary" onclick="wizard.saveProgress()">
                            Save Progress
                        </button>
                        <a href="faq.html" class="btn btn-link">
                            FAQ & Help
                        </a>
                        <a href="efiling-guides/efiling-guide.html" class="btn btn-link">
                            eFiling Guide
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right side: Tax Summary Sidebar -->
        <div class="tax-summary-sidebar">
            <div class="sidebar-header">
                <h3>Live Tax Summary</h3>
                <div class="update-indicator" id="updateIndicator">
                    <span class="dot"></span> Live
                </div>
            </div>

            <div class="live-summary">
                <div class="summary-item">
                    <span class="label">Gross Income</span>
                    <span class="value" id="liveGrossIncome">R0</span>
                </div>
                <div class="summary-item">
                    <span class="label">Deductions</span>
                    <span class="value" id="liveDeductions">R0</span>
                </div>
                <div class="summary-item">
                    <span class="label">Taxable Income</span>
                    <span class="value" id="liveTaxableIncome">R0</span>
                </div>
                <div class="summary-item highlight">
                    <span class="label">Tax Payable</span>
                    <span class="value" id="liveTaxPayable">R0</span>
                </div>
                <div class="summary-item">
                    <span class="label">Effective Rate</span>
                    <span class="value" id="liveEffectiveRate">0.0%</span>
                </div>
            </div>

            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step completed" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Personal</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Income</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Deductions</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Advanced</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Summary</div>
                </div>
            </div>

            <!-- Tax Tips -->
            <div class="tax-tips">
                <h4>💡 Tax Tips</h4>
                <div class="tip" id="currentTip">
                    <p>Complete all sections for the most accurate tax calculation.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Footer -->
    <footer class="compliance-footer">
        <div class="compliance-section">
            <div class="popia-notice">
                <h4>🔒 Privacy & Data Protection (POPIA Compliant)</h4>
                <p>Your personal information is protected under the Protection of Personal Information Act (POPIA). 
                   We collect and process your data solely for tax calculation purposes and do not share it with third parties.</p>
                <div class="compliance-links">
                    <a href="/privacy-policy.html">Privacy Policy</a>
                    <a href="/terms-of-service.html">Terms of Service</a>
                    <a href="/data-retention.html">Data Retention</a>
                </div>
            </div>

            <div class="disclaimer">
                <h4>⚖️ Legal Disclaimer</h4>
                <p><strong>Important:</strong> This calculator provides tax estimates based on current SARS regulations. 
                   Results are for informational purposes only and do not constitute professional tax advice. 
                   For complex tax situations, consult a registered tax practitioner.</p>
            </div>

            <div class="footer-branding">
                <p>&copy; 2025 TaxEasy_ZA. Professional South African Tax Solutions.</p>
                <div class="social-links">
                    <a href="#" class="social-link">Facebook</a>
                    <a href="#" class="social-link">Twitter</a>
                    <a href="#" class="social-link">LinkedIn</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Initialize Application -->
    <script>
        // Initialize the tax wizard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.wizard = new TaxWizard();
            window.payfast = new PayFastIntegration();
            window.pdfGenerator = new TaxReportPDF();
            
            // Set up real-time calculation updates
            setupRealTimeCalculations();
            
            console.log('TaxEasy_ZA Professional Calculator initialized successfully');
        });

        function setupRealTimeCalculations() {
            // Add event listeners to all input fields for real-time updates
            const inputs = document.querySelectorAll('input[type="number"], select');
            inputs.forEach(input => {
                input.addEventListener('input', debounce(updateLiveSummary, 300));
                input.addEventListener('change', updateLiveSummary);
            });
        }

        function updateLiveSummary() {
            try {
                const formData = collectFormData();
                const taxResult = window.taxEngine.calculateTax(
                    formData.grossIncome, 
                    formData.deductions
                );

                // Update live summary in sidebar
                document.getElementById('liveGrossIncome').textContent = `R${taxResult.grossIncome.toLocaleString()}`;
                document.getElementById('liveDeductions').textContent = `R${taxResult.totalDeductions.toLocaleString()}`;
                document.getElementById('liveTaxableIncome').textContent = `R${taxResult.taxableIncome.toLocaleString()}`;
                document.getElementById('liveTaxPayable').textContent = `R${taxResult.finalTax.toLocaleString()}`;
                document.getElementById('liveEffectiveRate').textContent = `${taxResult.effectiveRate}%`;

                // Show update indicator
                const indicator = document.getElementById('updateIndicator');
                indicator.classList.add('updated');
                setTimeout(() => indicator.classList.remove('updated'), 500);

            } catch (error) {
                console.error('Error updating live summary:', error);
            }
        }

        function collectFormData() {
            // Collect all form data for calculation
            const formData = {
                grossIncome: 0,
                deductions: {}
            };

            // Calculate gross income
            const incomeFields = ['basicSalary', 'bonus', 'commission', 'overtime', 
                                 'travelAllowance', 'cellphoneAllowance', 'otherAllowances',
                                 'interestIncome', 'dividendIncome', 'rentalIncome'];
            
            incomeFields.forEach(field => {
                const value = parseFloat(document.getElementById(field)?.value || 0);
                formData.grossIncome += value;
            });

            // Collect deductions
            formData.deductions = {
                age: document.getElementById('age')?.value || 'under65',
                retirementFunding: (parseFloat(document.getElementById('pensionFund')?.value || 0) +
                                   parseFloat(document.getElementById('providentFund')?.value || 0) +
                                   parseFloat(document.getElementById('retirementAnnuity')?.value || 0)),
                medicalAidContributions: parseFloat(document.getElementById('medicalAid')?.value || 0),
                medicalMembers: parseInt(document.getElementById('medicalMembers')?.value || 0),
                medicalDependants: parseInt(document.getElementById('medicalDependants')?.value || 0),
                otherDeductions: (parseFloat(document.getElementById('donations')?.value || 0) +
                                 parseFloat(document.getElementById('fuelExpenses')?.value || 0) +
                                 parseFloat(document.getElementById('homeOffice')?.value || 0))
            };

            return formData;
        }

        // Utility function for debouncing rapid input changes
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Professional report purchase function
        function purchaseProfessionalReport() {
            const formData = collectFormData();
            const userEmail = document.getElementById('email').value;
            
            if (!userEmail) {
                alert('Please provide an email address for report delivery.');
                document.getElementById('email').focus();
                return;
            }

            window.payfast.generatePaymentForm(99, 'Professional Tax Report 2025', userEmail);
        }

        // Basic report generation
        function generateBasicReport() {
            const formData = collectFormData();
            const userInfo = {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value
            };

            window.pdfGenerator.generateBasicReport(formData, userInfo);
        }
    </script>
    <script type="module" src="/js/privacy/session-manager.js"></script>
    <script type="module" src="/js/privacy/secure-forms.js"></script>
    <script type="module" src="/js/language/enhanced-language-handler.js"></script>
    <script type="module" src="/js/analytics/performance-monitor.js"></script>
</body>
</html>
