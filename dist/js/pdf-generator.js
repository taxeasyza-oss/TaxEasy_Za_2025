// PDF Generation and Payment Integration
const PAYFAST_SANDBOX_URL = 'https://sandbox.payfast.co.za/eng/process';
const MERCHANT_ID = '10000100';
const MERCHANT_KEY = '46f0cd694581a';

function initiatePayment(amount) {
    const params = new URLSearchParams({
        merchant_id: MERCHANT_ID,
        merchant_key: MERCHANT_KEY,
        return_url: window.location.origin + '/payment-return.html',
        cancel_url: window.location.origin + '/payment-cancel.html',
        amount: Math.abs(amount).toFixed(2),
        item_name: 'TaxEasy_ZA Tax Report',
        item_description: 'Professional Tax Calculation Report'
    });
    
    window.location.href = `${PAYFAST_SANDBOX_URL}?${params}`;
}

// Existing PDF generation functions below...
function generatePDF(taxData, lang) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const translations = window.translations[lang] || {};
    
    // Header
    doc.setFontSize(22);
    // Header with personal details
    doc.setFontSize(18);
    doc.text(document.getElementById('fullName')?.value || '', 20, 20);
    doc.setFontSize(12);
    doc.text([
        `ID: ${document.getElementById('idPassport')?.value || ''}`,
        `Age: ${document.getElementById('age')?.value || ''}`
    ], 20, 30);
    
    // Main title
    doc.setFontSize(20);
    doc.text(translations.tax_summary_title || "Tax Summary", 20, 45);
    
    // Income Section
    let yPos = 40;
    doc.setFontSize(16);
    doc.text(translations.income_summary || "Income Summary", 20, yPos);
    yPos += 10;
    doc.text(`${translations.gross_income || "Gross Income"}: R${taxData.grossIncome.toFixed(2)}`, 20, yPos);
    yPos += 10;
    doc.text(`${translations.total_deductions || "Total Deductions"}: R${taxData.totalDeductions.toFixed(2)}`, 20, yPos);
    yPos += 15;

    // Tax Calculation
    doc.setFontSize(16);
    doc.text(translations.tax_calculation || "Tax Calculation", 20, yPos);
    yPos += 10;
    doc.text(`${translations.tax_payable || "Tax Payable"}: R${taxData.taxAfterCredits.toFixed(2)}`, 20, yPos);
    yPos += 10;
    doc.text(`${translations.tax_paid || "Tax Paid"}: R${taxData.totalTaxPaid.toFixed(2)}`, 20, yPos);
    yPos += 15;

    // Final Result
    doc.setFontSize(16);
    const resultText = taxData.isRefund ? 
        translations.refund_due || "Refund Due" : 
        translations.tax_due || "Tax Due";
    doc.text(resultText, 20, yPos);
    yPos += 10;
    doc.setFontSize(22);
    doc.text(`R${Math.abs(taxData.finalAmount).toFixed(2)}`, 20, yPos);

    // Footer
    doc.setFontSize(10);
    doc.text(translations.pdf_footer || "Generated by TaxEasy ZA - POPIA Compliant", 20, 280);

    doc.save(`TaxSummary-${new Date().toISOString().slice(0,10)}.pdf`);
}
